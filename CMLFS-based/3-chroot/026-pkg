# Stage1: spkg
# Build and install under chroot
#
# Replaces installpkg, removepkg, and upgradepkg

# No autotools in llvmtools.
# Apply patch to skip use of ./autogen
patch -Np1 -i ../patches/spkg-autogen.patch 
chmod -v +x install-sh configure config.sub config.guess

# Configure
CC=clang CXX=clang++ \
AR=llvm-ar \
./configure --prefix=/llvmtools --build=$TUPLE

# Compile
make

# Install to llvmtools
make install

# Copy the makepkg script
install -v -m0755 ../files/makepkg /llvmtools/bin/

# Copy the script to intialize package database 
install -v -m0755 ../files/init-pkgdb /llvmtools/bin/

# Make sure scripts are executable
chmod -v +x /llvmtools/bin/{makepkg,init-pkgdb}

# Now is a good time to backup llvmtools for another build or
# for  installing built packages for a new system.

# Otherwise, intialize the package database for spkg.
init-pkgdb

# Setup the build variables
export BUILD="/BUILD" PKGS="/PKGS"
mkdir -v $BUILD $PKGS
export DESCS="/sources/files/descs"

# Setup the package naming scheme:
# $ARCH-$DISTRO_NAME-$ARCHIVE-TYPE
#
# Valid values for $ARCHIVE-TYPE
# txz - xz
# tgz - pigz/gzip
# tbz - bzip2 or lbzip2
# tlz - lzma
# Additional, but requires support in llvmtools:
# tz4 - lz4
# tzo - lzop
# tbr - brotli

export   PSUFFIX="$(uname -m)-cmlfs.txz"
export NOPSUFFIX="noarch-cmlfs.txz"
