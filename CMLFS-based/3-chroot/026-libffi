# Stage1: libffi
# Build and install under chroot
#
# Required by glib

# Configure source. If host and target are the same machine, 
# use  -with-gcc-arch=native instead 
# Refer to:
# https://gcc.gnu.org/onlinedocs/gcc-9.2.0/gcc/x86-Options.html

case $(uname -m) in
 x86_64) export ARCH="x86-64"
         ;;
 i686)   export ARCH="i686"
         ;;
 armv7l) export ARCH="armv7-a"
         ;;
 armv6l) export ARCH="armv6"
         ;;
 aarch64) export ARCH="armv8-a"
         ;;
esac

export CFLAGS="-Wno-implicit-function-declaration "

# Configure
CC=clang    CXX=clang++ \
AR=llvm-ar  AS=llvm-as  \
RANLIB=llvm-ranlib      \
NM=llvm-nm \
LD=ld.lld   STRIP=llvm-strip \
./configure --build=${TUPLE} \
            --host=${TUPLE}  \
            --prefix=/llvmtools \
            --disable-static \
            --includedir=/llvmtools/include \
            --disable-multi-os-directory \
            --with-pic --with-gcc-arch=$ARCH
# Compile
make

# Install to llvmtools
make install
unset ARCH CFLAGS
