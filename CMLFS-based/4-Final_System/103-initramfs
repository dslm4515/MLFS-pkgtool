# Final System: initramfs
# This section is done in Chroot environment

# This is optional. 

# Create a directory to hold the contents of
# the initramfs
mkdir -pv /sources/initramfs_build

# Enter directory and create a base 
# directory tree:
cd /sources/initramfs_build
mkdir -pv dev etc proc run sys usr/bin
mkdir -pv usr/lib/{firmware,modules,udev}
mkdir -pv etc/{modprobe.d,udev}

# Create symlinks
ln -sv usr/bin bin
ln -sv usr/bin sbin
ln -sv usr/lib lib
ln -sv usr/lib lib64
ln -sv bin usr/sbin

# Copy busybox
cp -v /sources/busybox-1.36.1/busybox usr/bin/

# Create symlinks for utilities needed
for b in cat cp dd killall kmod ln ls mkdir \
         mknod mount rm sed sh sleep umount \
         uname basename readlink insmod lsmod
do
  ln -sv busybox usr/bin/$b
done 

# Perhaps copy s6-portable-utils instead of from coreutils & util-linux
# Copy binaries
#for b in cat cp dd killall kmod ln ls mkdir \
#         mknod mount rm sed sh sleep umount \
#         uname dash
#do 
#  cp -va /usr/bin/$b bin/
#done
#cp -va /usr/bin/basename bin/
#cp -va /usr/bin/readlink bin/
#ln -sv kmod bin/insmod
#ln -sv kmod bin/lsmod

# Create the nodes for udev to mount on:
mknod -m 600 dev/console c 5 1
mknod -m 666 dev/null c 1 3

# Copy udev configuration
cp -v  /etc/udev/udev.conf etc/udev/
cp -rv /etc/udev/rules.d   etc/udev/
cp -rv /lib/udev/*         lib/udev/

# Set module load order, if needed
touch etc/modprobe.d/modprobe.conf 

# Copy the init script
cp -v ../files/initramfs-init sbin/init

# Copy required libraries
#for l in libacl.so.1  libattr.so.1 libblkid.so.1 libcap.so.2 \
#         libkmod.so.2 liblzma.so.5 libmount.so.1 libncursesw.so.6 \
#         libreadline.so.8 libz.so.1
#do
#  cp -va /lib/$l lib/
#done
cp -v /usr/lib/libc.so  usr/lib
ln -sv libc.so usr/lib/ld-musl-${MCA}.so.1

# Copy any firmware required for boot:
cp -rv /lib/firmware/* lib/firmware/

# Copy any kernel modules:
cp -rv /lib/modules/* lib/modules/

# Now create the initramfs image. Do not change directories
find . | cpio -o -H newc | gzip -9  > /boot/initrd.img

