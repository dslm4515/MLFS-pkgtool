# Final System: Python 3
# This section is done in Chroot environment

export PNAME="python3"  &&
export   VER="3.11.3" &&
export  MJOB="-j2"   &&

# Apply patch to build under musl, from Alpine Linux
patch -Np1 -i ../patches/python-alpine/musl-find_library.patch

# Remove to ensure system libraries are used.
rm -r Modules/expat
rm -r Modules/_ctypes/{darwin,libffi}*

# Configure source
CC=clang CXX=clang++            \
./configure --prefix=/usr       \
            --enable-shared     \
            --with-system-expat \
            --with-system-ffi   \
            --with-ensurepip=yes \
            --enable-ipv6 \
            --enable-loadable-sqlite-extensions \
            --with-computed-gotos \
            --enable-ipv6 \
            --with-openssl=/opt/openssl \
            --with-openssl-rpath=/opt/openssl/lib

# Build and install
make && make DESTDIR=$BUILD install

# Change permissions to allow stripping later
chmod -v 755 $BUILD/usr/lib/libpython3.11.so
chmod -v 755 $BUILD/usr/lib/libpython3.so

# Pip3 expects to find /usr/bin/python. Python2 is no longer
# used nor built.
# Create the missing link
ln -sv python3 $BUILD/usr/bin/python

# Build package
cd ${BUILD} && mkdir -v ${BUILD}/install          &&
cp -v $DESCS/${PNAME} ${BUILD}/install/slack-desc &&
makepkg -l y -c n $PKGS/${PNAME}-${VER}-$PSUFFIX  &&

# Clean stage area
rm -rf ${BUILD}/* &&

# Install
spkg $PKGS/${PNAME}-${VER}-$PSUFFIX
