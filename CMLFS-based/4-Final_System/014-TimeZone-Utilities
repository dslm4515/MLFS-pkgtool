# Final System: TimeZone Utilites & Data
# This section is done in Chroot environment
# https://www.iana.org/time-zones

export PNAME="tzdb"  &&
export   VER="2023c" &&
export  MJOB="-j2"

export timezones="africa antarctica asia australasia europe northamerica \
                  southamerica etcetera backward factory"
mkdir tzdb && cd tzdb && 
tar xf ../pkgs/tzdata2023c.tar.gz &&
tar xf ../pkgs/tzcode2023c.tar.gz &&
tar xf ../pkgs/posixtz-0.5.tar.xz &&

# Apply patches from Alpine Linux
patch -Np1 -i ../patches/posixtz-alpine/0001-posixtz-ensure-the-file-offset-we-pass-to-lseek-is-o.patch 
patch -Np1 -i ../patches/posixtz-alpine/0002-fix-implicit-declaration-warnings-by-including-strin.patch

# Patch makefile to use llvm-ar instead of binutils' ar
# and use clang instead of cc
patch -Np1 -i ../patches/tzcode-cmlfs/change-ar-to-llvm-ar.patch

# Compile
make CFLAGS="$CFLAGS -DHAVE_STDINT_H=1" TZDIR="/usr/share/zoneinfo"  
make -C posixtz-0.5 posixtz

# Install
mkdir -pv $BUILD/usr/share/zoneinfo/right 
mkdir -pv $BUILD/usr/{,s}bin
mkdir -pv $BUILD/usr/share/man/man8

./zic -y ./yearistype -d $BUILD/usr/share/zoneinfo ${timezones}
./zic -y ./yearistype -d $BUILD/usr/share/zoneinfo/right -L leapseconds ${timezones}
./zic -y ./yearistype -d $BUILD/usr/share/zoneinfo -p America/New_York
install -m444 -v iso3166.tab zone1970.tab zone.tab $BUILD/usr/share/zoneinfo
install -m755 tzselect  $BUILD/usr/bin
install -m755 zic zdump $BUILD/usr/sbin
install -m644 zic.8 zdump.8 $BUILD/usr/share/man/man8
install -Dm755 posixtz-0.5/posixtz $BUILD/usr/bin/posixtz
install -Dm644 leap-seconds.list $BUILD/usr/share/zoneinfo/
unset timezones

# Build package
cd ${BUILD} && mkdir -v ${BUILD}/install  &&
cp -v $DESCS/${PNAME} ${BUILD}/install/slack-desc &&
makepkg -l y -c n $PKGS/${PNAME}-${VER}-$PSUFFIX  &&

# Clean stage area
rm -rf ${BUILD}/* &&

# Install
spkg $PKGS/${PNAME}-${VER}-$PSUFFIX

# use tzselect to determine <xxx>
ln -sv /usr/share/zoneinfo/<xxx> /etc/localtime

