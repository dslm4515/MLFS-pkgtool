# Final System: elftools
# Build under chroot
#
# NOTE: Replaced binutils and libelf(elfutils)
# NOTE: Requires bmake, lsb-tools, libarchive, musl-compat-headers

export PNAME="elftoolchain"  &&
export   VER="0.7.1_16APR2023" &&
export  MJOB="-j2"   &&

# Apply patch such that the tools can report a more descriptive 
# version number
patch -Np1 -i ../patches/elftoolchain-cmlfs/fix-version.patch 

# Apply patches from Chimera Linux
patch -Np1 -i ../patches/elftoolchain-chimera/0001-disable-ld-build.patch
patch -Np1 -i ../patches/elftoolchain-chimera/allow-empty-elf-data.patch
patch -Np1 -i ../patches/elftoolchain-chimera/cxxfilt.patch
patch -Np1 -i ../patches/elftoolchain-chimera/use-symlinks.patch
patch -Np1 -i ../patches/elftoolchain-chimera/werror.patch

# Apply patch such that the tools can report a more descriptive 
# version number
patch -Np1 -i ../patches/elftoolchain-cmlfs/fix-version.patch

# Source is hard-coded for ar, ranlib, and strip (either binutils or 
# elftoolchain).
for t in ar as ranlib strip
do
  ln -sv llvm-$t /llvmtools/bin/$t
done 

# Compile
bmake WITH_ADDITIONAL_DOCUMENTATION=no \
      WITH_TESTS=no \
      MANTARGET=man 

# Install
bmake WITH_ADDITIONAL_DOCUMENTATION=no \
      WITH_TESTS=no \
      MANTARGET=man \
      DESTDIR=$BUILD install

# Install musl-compatible elfdefinitions.h
mkdir -pv $BUILD/usr/include/sys
cp -v ../files/elftoolchain-chimera/elfdefinitions.h $BUILD/usr/include/sys/

# Fix symlinks
for b in mcs objcopy ranlib strip
do
  rm -v $BUILD/usr/bin/$b
done
ln -sv elfcopy $BUILD/usr/bin/mcs
ln -sv elfcopy $BUILD/usr/bin/objcopy
ln -sv ar      $BUILD/usr/bin/ranlib
ln -sv elfcopy $BUILD/usr/bin/strip

# Build package
cd ${BUILD} && mkdir -v ${BUILD}/install          &&
cp -v $DESCS/${PNAME} ${BUILD}/install/slack-desc &&
makepkg -l y -c n $PKGS/${PNAME}-${VER}-$PSUFFIX  &&

# Clean stage area
rm -rf ${BUILD}/* &&

# Install
spkg $PKGS/${PNAME}-${VER}-$PSUFFIX
